<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Break Depo Bank WM</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Premium Navy Gradient Theme */
        .bg-navy-gradient { 
            background: linear-gradient(135deg, #020617 0%, #1e3a8a 100%); 
        }
        
        /* Efek Cekung (Concave) untuk Input */
        .concave-input {
            box-shadow: inset 3px 3px 6px rgba(0,0,0,0.08), inset -2px -2px 5px rgba(255,255,255,0.7);
            border: 1px solid #e2e8f0;
            background-color: #fcfcfd;
        }
        .concave-input:focus {
            box-shadow: inset 2px 2px 5px rgba(30, 58, 138, 0.15);
            border-color: #2563eb;
            background-color: #ffffff;
        }

        /* Efek Emboss (Cembung) untuk Tombol */
        .emboss-btn {
            background: linear-gradient(145deg, #2563eb, #1e3a8a);
            box-shadow: 5px 5px 12px rgba(0,0,0,0.3), -2px -2px 6px rgba(255,255,255,0.05);
            transition: all 0.2s ease;
        }
        .emboss-btn:active {
            box-shadow: inset 3px 3px 8px rgba(0,0,0,0.5);
            transform: translateY(1px);
        }

        .no-wrap { white-space: nowrap; }
        /* Padding tabel diatur agar lebih lebar untuk HP */
        .detail-table td { padding: 10px 4px; border-bottom: 1px solid #f8fafc; }
    </style>
</head>
<body class="text-slate-800">

    <div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-2xl flex flex-col relative overflow-hidden">
        
        <!-- HEADER -->
        <header class="bg-navy-gradient text-white p-5 sticky top-0 z-50 shadow-xl border-b border-white/10">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 flex items-center justify-center text-2xl bg-white/10 rounded-full backdrop-blur-sm shadow-inner">
                        <i class="fas fa-calculator"></i>
                    </div>
                    <div class="flex flex-col">
                        <h1 id="headerTitle" class="text-base font-extrabold leading-none tracking-tight">Kalkulator Break Depo Bank WM</h1>
                    </div>
                </div>
                <!-- Nav Toggle Button -->
                <button onclick="toggleViewAuto()" class="w-10 h-10 flex items-center justify-center bg-white/10 rounded-xl hover:bg-white/20 transition active:scale-90 shadow-lg border border-white/5">
                    <i id="navIcon" class="fas fa-history text-sm text-blue-200"></i>
                </button>
            </div>
        </header>

        <div id="content" class="flex-1 overflow-y-auto bg-slate-50/20">
            <!-- VIEW: KALKULATOR -->
            <div id="calcView" class="p-6 space-y-6 fade-in">
                <div class="space-y-5">
                    <!-- Nominal Deposito -->
                    <div class="space-y-1.5">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1 text-left block">Nominal Deposito</label>
                        <div class="relative">
                            <span class="absolute left-4 top-3.5 font-black text-blue-800 text-sm">Rp</span>
                            <input 
                                type="text" id="nominal" inputmode="numeric" oninput="formatInput(this)" 
                                class="w-full pl-11 pr-4 py-3.5 bg-white concave-input rounded-2xl font-bold text-base transition-all placeholder-slate-300 outline-none" 
                                placeholder="0"
                            >
                        </div>
                    </div>

                    <!-- Tanggal -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1.5 text-left">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1">Tanggal Tanam</label>
                            <input type="date" id="tglTanam" class="w-full p-3.5 bg-white concave-input rounded-2xl font-bold text-xs outline-none focus:ring-2 focus:ring-blue-100">
                        </div>
                        <div class="space-y-1.5 text-left">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1">Tanggal Break</label>
                            <input type="date" id="tglBreak" class="w-full p-3.5 bg-white concave-input rounded-2xl font-bold text-xs outline-none focus:ring-2 focus:ring-blue-100">
                        </div>
                    </div>

                    <!-- Jangka Waktu Awal -->
                    <div class="space-y-1.5 text-left">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1">Jangka Waktu Awal</label>
                        <select id="tenor" class="w-full p-3.5 bg-white concave-input rounded-2xl font-extrabold text-sm outline-none appearance-none bg-[url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%232563eb%22%20stroke-width%3D%223%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Cpolyline%20points%3D%226%209%2012%2015%2018%209%22%3E%3C%2Fpolyline%3E%3C%2Fsvg%3E')] bg-[length:16px_16px] bg-[right_1.2rem_center] bg-no-repeat">
                            <option value="">Pilih Tenor</option>
                            <option value="1">1 Bulan</option>
                            <option value="3">3 Bulan</option>
                            <option value="6">6 Bulan</option>
                            <option value="12">12 Bulan</option>
                            <option value="24">24 Bulan</option>
                            <option value="36">36 Bulan</option>
                            <option value="60">60 Bulan</option>
                        </select>
                    </div>

                    <!-- Re-Invest -->
                    <div class="p-5 bg-white rounded-[2rem] border border-slate-100 shadow-sm space-y-4 text-left">
                        <div class="flex items-center gap-3 cursor-pointer" onclick="toggleReinvest()">
                            <div id="checkReinvest" class="w-6 h-6 rounded-lg border-2 bg-slate-50 border-slate-200 transition flex items-center justify-center text-white text-[12px] shadow-sm">âœ“</div>
                            <span class="text-[13px] font-black text-slate-700">Pencairan Re-Invest</span>
                        </div>
                        <div id="reinvestOptions" class="hidden space-y-4 pt-4 border-t border-slate-50 animate-in">
                            <div class="flex gap-6">
                                <label class="flex items-center gap-2.5 cursor-pointer text-xs font-black text-slate-500">
                                    <input type="radio" name="reType" value="all" checked onclick="handleReType('all')" class="w-4 h-4 accent-blue-600"> Seluruhnya
                                </label>
                                <label class="flex items-center gap-2.5 cursor-pointer text-xs font-black text-slate-500">
                                    <input type="radio" name="reType" value="partial" onclick="handleReType('partial')" class="w-4 h-4 accent-blue-600"> Sebagian
                                </label>
                            </div>
                            <div id="partialInput" class="hidden">
                                <div class="relative">
                                    <span class="absolute left-3 top-2.5 font-black text-blue-800 text-[10px]">Rp</span>
                                    <input type="text" id="nominalReinvest" inputmode="numeric" oninput="formatInput(this)" class="w-full pl-8 pr-4 py-3 bg-slate-50 concave-input rounded-2xl text-sm font-bold" placeholder="Nominal Baru">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="grid grid-cols-2 gap-4 pt-2">
                    <button onclick="resetApp()" class="py-4 bg-slate-100 text-slate-500 font-black rounded-2xl hover:bg-slate-200 transition text-xs uppercase tracking-widest">Reset</button>
                    <button onclick="calculate()" class="py-4 emboss-btn text-white font-black rounded-2xl text-xs uppercase tracking-widest">Hitung Break</button>
                </div>

                <!-- HASIL -->
                <div id="resultCard" class="hidden bg-white rounded-[3rem] p-7 border border-blue-50 shadow-2xl space-y-7 fade-in relative overflow-hidden text-left">
                    <div class="absolute top-0 left-0 w-full h-1.5 bg-blue-700"></div>
                    <div class="text-center space-y-1">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.3em]">Estimasi Pencairan Bersih</p>
                        <h2 id="resTotal" class="text-3xl font-black text-blue-900 no-wrap tracking-tighter">Rp 0</h2>
                        <div id="resTotalBenefit" class="text-[10px] text-slate-400 mt-2 font-bold italic opacity-80 leading-relaxed px-2"></div>
                    </div>

                    <div class="space-y-4">
                        <div class="flex justify-between text-[11px] items-center"><span class="text-slate-500 font-bold uppercase tracking-widest">Umur Deposito</span><span id="resUmur" class="font-black text-slate-900 text-right">-</span></div>
                        <div class="flex justify-between text-[11px] items-center text-red-600"><span id="penaltyLabel" class="font-bold uppercase tracking-widest">Denda Penalty</span><span id="resPenalty" class="font-black">-</span></div>
                        <div class="flex justify-between text-[11px] text-red-600 border-b border-slate-100 pb-5 items-start">
                            <div class="flex flex-col text-left">
                                <span class="font-bold uppercase tracking-widest leading-none text-left">Kelebihan Bunga</span>
                                <span class="text-[9px] opacity-60 italic mt-1 text-left">(Wajib Dikembalikan)</span>
                            </div>
                            <div class="flex flex-col items-end">
                                <span id="resReversal" class="font-black text-lg">-</span>
                                <button id="detailToggleBtn" onclick="toggleDetails()" class="text-[11px] text-blue-700 font-black mt-2 underline flex items-center gap-1 hover:text-blue-950 transition">
                                    <span>Lihat Rincian</span> <i class="fas fa-chevron-down text-[8px]"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Rincian Dropdown (Padding diperkecil untuk melebarkan tabel) -->
                        <div id="details" class="hidden px-2.5 py-5 bg-blue-50/50 rounded-[2rem] text-[11px] space-y-4 border border-blue-100/50 fade-in">
                            <div class="p-3.5 mx-1 bg-white rounded-2xl font-bold border border-blue-100 shadow-sm leading-tight text-blue-900 flex flex-col text-left">
                                <span class="text-[9px] opacity-50 uppercase font-black tracking-widest">Memo Suku Bunga:</span>
                                <span id="detMemo" class="text-[11px] font-extrabold mt-1">-</span>
                            </div>
                            <div class="bg-white rounded-2xl border border-slate-100 overflow-hidden shadow-sm mx-1">
                                <table class="w-full detail-table text-[10px]">
                                    <thead class="bg-slate-50 text-slate-400 font-black uppercase text-[8px] tracking-wider">
                                        <tr>
                                            <td>Periode</td>
                                            <td class="text-center">Tenor</td>
                                            <td class="text-right">Bunga</td>
                                        </tr>
                                    </thead>
                                    <tbody id="detTableBody" class="text-slate-600"></tbody>
                                </table>
                            </div>
                            <div class="p-4 mx-1 bg-white rounded-2xl border border-slate-100 space-y-2.5 shadow-sm">
                                <div class="flex justify-between text-slate-500 font-bold"><span>Bunga Sudah Dibayar</span><span id="detBungaPaid" class="text-slate-900 font-black">-</span></div>
                                <div class="flex justify-between text-slate-500 font-bold"><span>Bunga Seharusnya</span><span id="detBungaSeharusnya" class="text-emerald-600 font-black">-</span></div>
                                <div class="pt-3 border-t border-slate-100 flex justify-between items-center">
                                    <span class="uppercase text-[9px] font-black tracking-widest text-slate-900">Total Selisih</span>
                                    <span id="detTotalDiff" class="text-red-600 font-black text-base">-</span>
                                </div>
                            </div>
                            <!-- Catatan Rumus Terbaru -->
                            <p class="text-[8px] text-slate-400 italic text-center leading-relaxed opacity-80 font-medium px-2">
                                * Sisa masa &lt; 1 bulan = 0%.<br>
                                * Rumus harian 365 hari (366 untuk kabisat)
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: HISTORY -->
            <div id="historyView" class="hidden p-6 space-y-5 fade-in text-left">
                <div class="p-5 bg-blue-50 text-blue-900 rounded-[1.5rem] flex gap-3 items-start border border-blue-100 shadow-sm">
                    <i class="fas fa-info-circle mt-1 text-blue-400"></i>
                    <p class="text-xs leading-relaxed font-bold">Daftar histori memo suku bunga. Perhitungan merujuk pada memo saat Tanggal Tanam.</p>
                </div>
                <div id="historyList" class="space-y-4"></div>
            </div>
        </div>

        <!-- FOOTER -->
        <footer class="bg-navy-gradient text-white p-6 text-center shrink-0 border-t border-white/10 shadow-[0_-4px_15px_rgba(0,0,0,0.2)]">
            <div class="flex items-center justify-center gap-3 group">
                <div class="w-8 h-8 border-2 border-white/40 rounded-full flex items-center justify-center font-black text-[10px] bg-white/5 shadow-inner">BD</div>
                <div class="text-xs font-black tracking-[0.2em] uppercase">Bizdev Bank WM</div>
            </div>
        </footer>
    </div>

    <script>
        const DATA_MEMO_BUNGA = [
            { date: "2025-08-28", rates: { 1: 4.5, 3: 4.75, 6: 5.25, 12: 5.5, 24: 6.5, 36: 7.0, 60: 8.25 } },
            { date: "2023-02-01", rates: { 1: 4.75, 3: 5.0, 6: 5.5, 12: 5.75, 24: 6.75, 36: 7.25, 60: 8.5 } },
            { date: "2021-09-30", rates: { 1: 4.5, 3: 4.75, 6: 5.25, 12: 5.5, 24: 6.5, 36: 7.0, 60: 8.25 } },
            { date: "2021-05-29", rates: { 1: 4.75, 3: 5.0, 6: 5.5, 12: 5.75, 24: 6.75, 36: 7.25, 60: 8.25 } },
            { date: "2021-05-01", rates: { 1: 5.0, 3: 5.25, 6: 5.75, 12: 6.0, 24: 7.0, 36: 7.5, 60: 8.25 } },
            { date: "2021-02-25", rates: { 1: 5.25, 3: 5.5, 6: 5.75, 12: 6.0, 24: 7.0, 36: 7.5, 60: 8.25 } },
            { date: "2021-01-26", rates: { 1: 5.5, 3: 5.75, 6: 6.0, 12: 6.25, 24: 7.25, 36: 7.75, 60: 8.25 } },
            { date: "2020-11-25", rates: { 1: 5.5, 3: 6.0, 6: 6.25, 12: 6.5, 24: 7.25, 36: 7.75, 60: 8.25 } },
            { date: "2020-10-01", rates: { 1: 6.0, 3: 6.5, 6: 6.75, 12: 7.0, 24: 7.75, 36: 8.25, 60: 8.75 } },
            { date: "2020-07-30", rates: { 1: 6.25, 3: 6.75, 6: 7.0, 12: 7.25, 24: 8.0, 36: 8.25, 60: 8.75 } },
            { date: "2020-01-29", rates: { 1: 6.5, 3: 7.0, 6: 7.25, 12: 7.5, 24: 8.0, 36: 8.25, 60: 8.75 } }
        ];

        let currentView = 'calc';
        let isReinvest = false;
        let reType = 'all';
        const AVAILABLE_TENORS = [60, 36, 24, 12, 6, 3, 1];

        function formatInput(el) {
            let val = el.value.replace(/\D/g, "");
            el.value = val.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        function formatNumber(num) {
            return Math.round(num).toLocaleString('id-ID');
        }

        function formatRupiah(num) {
            return 'Rp ' + formatNumber(num);
        }

        function formatDateReadable(date) {
            const d = new Date(date);
            const options = { day: '2-digit', month: 'short', year: 'numeric' };
            return d.toLocaleDateString('id-ID', options).replace(/\./g, '');
        }

        function formatDateShort(date) {
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}-${month}-${year}`;
        }

        function toggleReinvest() {
            isReinvest = !isReinvest;
            const box = document.getElementById('checkReinvest');
            const opt = document.getElementById('reinvestOptions');
            if (isReinvest) {
                box.classList.replace('bg-slate-50', 'bg-blue-600');
                box.classList.replace('border-slate-200', 'border-blue-600');
                opt.classList.remove('hidden');
            } else {
                box.classList.replace('bg-blue-600', 'bg-slate-50');
                box.classList.replace('border-blue-600', 'border-slate-200');
                opt.classList.add('hidden');
            }
        }

        function handleReType(type) {
            reType = type;
            document.getElementById('partialInput').classList.toggle('hidden', type !== 'partial');
        }

        function toggleViewAuto() {
            toggleView(currentView === 'calc' ? 'history' : 'calc');
        }

        function toggleView(view) {
            currentView = view;
            const calc = document.getElementById('calcView');
            const history = document.getElementById('historyView');
            const navIcon = document.getElementById('navIcon');

            if (view === 'history') {
                calc.classList.add('hidden');
                history.classList.remove('hidden');
                navIcon.className = 'fas fa-calculator';
                renderHistory();
            } else {
                calc.classList.remove('hidden');
                history.classList.add('hidden');
                navIcon.className = 'fas fa-history';
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function toggleDetails() {
            const details = document.getElementById('details');
            const btn = document.getElementById('detailToggleBtn');
            details.classList.toggle('hidden');
            
            if (details.classList.contains('hidden')) {
                btn.innerHTML = '<span>Lihat Rincian</span> <i class="fas fa-chevron-down text-[8px]"></i>';
            } else {
                btn.innerHTML = '<span>Tutup Rincian</span> <i class="fas fa-chevron-up text-[8px]"></i>';
                setTimeout(() => {
                    details.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }, 100);
            }
        }

        function isLeapYear(year) {
            return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
        }

        function getActiveMemo(date) {
            const sorted = [...DATA_MEMO_BUNGA].sort((a, b) => new Date(b.date) - new Date(a.date));
            const idx = sorted.findIndex(m => new Date(m.date) <= date);
            return idx === -1 ? sorted[sorted.length - 1] : sorted[idx];
        }

        function addMonths(date, months) {
            const d = new Date(date);
            d.setMonth(d.getMonth() + months);
            return d;
        }

        function getDetailedAgeText(totalDays) {
            let years = Math.floor(totalDays / 365);
            let remainingAfterYears = totalDays % 365;
            let months = Math.floor(remainingAfterYears / 30);
            let days = remainingAfterYears % 30;

            let parts = [];
            if (years > 0) parts.push(`${years} thn`);
            if (months > 0) parts.push(`${months} bln`);
            if (days > 0) parts.push(`${days} hr`);
            
            return parts.length > 0 ? `(${parts.join(' ')})` : '';
        }

        function resetApp() {
            document.getElementById('nominal').value = '';
            document.getElementById('tenor').value = '';
            document.getElementById('tglTanam').value = '';
            document.getElementById('nominalReinvest').value = '';
            document.getElementById('resultCard').classList.add('hidden');
            if(isReinvest) toggleReinvest();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function calculate() {
            const nominalStr = document.getElementById('nominal').value;
            const tenorKontrak = document.getElementById('tenor').value;
            const tglTanamStr = document.getElementById('tglTanam').value;
            const tglBreakStr = document.getElementById('tglBreak').value;

            if (!nominalStr || !tenorKontrak || !tglTanamStr) {
                return alert("Mohon lengkapi Nominal, Jangka Waktu Awal, dan Tanggal Tanam!");
            }

            const nominal = parseFloat(nominalStr.replace(/\./g, '')) || 0;
            const startOrig = new Date(tglTanamStr);
            const breakDate = new Date(tglBreakStr);

            if (breakDate <= startOrig) return alert("Tanggal Break tidak boleh sebelum/sama dengan Tanggal Tanam!");

            const totalDays = Math.ceil(Math.abs(breakDate - startOrig) / (1000 * 60 * 60 * 24));
            const masterMemo = getActiveMemo(startOrig);
            const rateKontrak = masterMemo.rates[tenorKontrak] || 0;

            const sortedMemo = [...DATA_MEMO_BUNGA].sort((a, b) => new Date(b.date) - new Date(a.date));
            const masterIdx = sortedMemo.findIndex(m => m.date === masterMemo.date);
            let memoLabel = `${formatDateReadable(masterMemo.date)} s/d `;
            if (masterIdx === 0) memoLabel += "Sekarang";
            else {
                const nextDate = new Date(sortedMemo[masterIdx - 1].date);
                nextDate.setDate(nextDate.getDate() - 1);
                memoLabel += formatDateReadable(nextDate);
            }
            document.getElementById('detMemo').innerText = memoLabel;

            const divPaid = isLeapYear(startOrig.getFullYear()) ? 366 : 365;
            const bungaPaidTotal = (nominal * (rateKontrak / 100) * totalDays) / divPaid;

            let currentDate = new Date(startOrig);
            let totalBungaSeharusnya = 0;
            let breakdownHtml = "";
            let sumMonths = 0;

            while (true) {
                let monthsRem = (breakDate.getFullYear() - currentDate.getFullYear()) * 12 + (breakDate.getMonth() - currentDate.getMonth());
                if (breakDate.getDate() < currentDate.getDate()) monthsRem--;
                if (monthsRem < 1) break;

                let selectedT = 1;
                for (let t of AVAILABLE_TENORS) {
                    if (monthsRem >= t) { selectedT = t; break; }
                }

                const rateAktualBlock = masterMemo.rates[selectedT];
                const blockEndDate = addMonths(currentDate, selectedT);
                const blockDays = Math.ceil(Math.abs(blockEndDate - currentDate) / (1000 * 60 * 60 * 24));
                const divisor = isLeapYear(currentDate.getFullYear()) ? 366 : 365;
                const bungaBlok = (nominal * (rateAktualBlock / 100) * blockDays) / divisor;
                
                totalBungaSeharusnya += bungaBlok;
                sumMonths += selectedT;

                let tenorLabel = selectedT >= 12 ? `${selectedT/12} thn` : `${selectedT} bln`;

                breakdownHtml += `
                    <tr>
                        <td class="leading-tight text-slate-500 font-medium">${formatDateReadable(currentDate)} s/d ${formatDateReadable(blockEndDate)}</td>
                        <td class="text-center text-blue-900 font-black">${tenorLabel}</td>
                        <td class="text-right text-slate-800 font-black">${formatNumber(bungaBlok)} <span class="text-[7px] text-slate-400 font-bold">(${rateAktualBlock}%)</span></td>
                    </tr>
                `;
                currentDate = blockEndDate;
            }

            const remDays = Math.ceil(Math.abs(breakDate - currentDate) / (1000 * 60 * 60 * 24));
            if (remDays > 0) {
                breakdownHtml += `
                    <tr class="bg-red-50/10">
                        <td class="text-red-400 italic font-medium">${formatDateReadable(currentDate)} s/d ${formatDateReadable(breakDate)}</td>
                        <td class="text-center text-red-300 font-black">${remDays} hr</td>
                        <td class="text-right text-red-500 font-black">0 <span class="text-[7px] opacity-40">(0%)</span></td>
                    </tr>
                `;
            }

            const reversal = Math.max(0, bungaPaidTotal - totalBungaSeharusnya);
            let penalty = 0;
            if (isReinvest) {
                if (reType === 'all') {
                    penalty = 0;
                    document.getElementById('penaltyLabel').innerText = "Denda Penalty (Ditanam)";
                } else {
                    const reNominalStr = document.getElementById('nominalReinvest').value;
                    const reNominal = parseFloat(reNominalStr.replace(/\./g, '')) || 0;
                    const sisa = Math.max(0, nominal - reNominal);
                    penalty = sisa * 0.001;
                    document.getElementById('penaltyLabel').innerText = "Denda Penalty (0,1% Sisa)";
                }
            } else {
                penalty = nominal * 0.001;
                document.getElementById('penaltyLabel').innerText = "Denda Penalty (0,1%)";
            }

            const totalReceived = nominal - penalty - reversal;
            const totalBenefit = totalReceived + bungaPaidTotal;

            document.getElementById('resTotal').innerText = formatRupiah(totalReceived);
            document.getElementById('resTotalBenefit').innerHTML = `
                Hasil Investasi Bersih: <span class="text-blue-900 font-black">${formatRupiah(totalBenefit)}</span><br>
                <span class="text-[9px] opacity-70">(Pokok Cair ${formatNumber(totalReceived)} + Bunga Sudah Diterima ${formatNumber(bungaPaidTotal)})</span>
            `;
            
            document.getElementById('resUmur').innerText = `${formatNumber(totalDays)} Hari ${getDetailedAgeText(totalDays)}`;
            document.getElementById('resPenalty').innerText = "-" + formatRupiah(penalty);
            document.getElementById('resReversal').innerText = "-" + formatRupiah(reversal);
            
            document.getElementById('detTableBody').innerHTML = breakdownHtml;
            document.getElementById('detBungaPaid').innerText = formatRupiah(bungaPaidTotal);
            document.getElementById('detBungaSeharusnya').innerText = formatRupiah(totalBungaSeharusnya);
            document.getElementById('detTotalDiff').innerText = formatRupiah(reversal);

            document.getElementById('resultCard').classList.remove('hidden');
            document.getElementById('details').classList.add('hidden');
            document.getElementById('detailToggleBtn').innerHTML = '<span>Lihat Rincian</span> <i class="fas fa-chevron-down text-[8px]"></i>';
            
            setTimeout(() => {
                document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth', block: 'end' });
            }, 150);
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            const sorted = [...DATA_MEMO_BUNGA].sort((a, b) => new Date(b.date) - new Date(a.date));

            sorted.forEach((memo, idx) => {
                const tglMulai = formatDateReadable(memo.date);
                let label = (idx === 0) ? `Berlaku ${tglMulai} s/d Sekarang` : `Berlaku ${tglMulai} s/d ${formatDateReadable(new Date(new Date(sorted[idx-1].date).getTime() - 86400000))}`;

                let ratesHtml = '';
                AVAILABLE_TENORS.forEach(t => {
                    let tLabel = t >= 12 ? `${t/12} thn` : `${t} bln`;
                    ratesHtml += `<div class="bg-white p-2.5 rounded-xl text-center border border-slate-100 shadow-sm"><p class="text-[7px] text-slate-400 font-black uppercase">${tLabel}</p><p class="text-[11px] font-black text-blue-900">${memo.rates[t]}%</p></div>`;
                });

                list.innerHTML += `
                    <div class="p-6 bg-white border border-slate-100 rounded-[2rem] space-y-4 shadow-sm text-left">
                        <div class="border-b border-slate-50 pb-3"><span class="text-[10px] font-black text-blue-950 uppercase tracking-[0.2em] opacity-40">${label}</span></div>
                        <div class="grid grid-cols-4 gap-3">${ratesHtml}</div>
                    </div>
                `;
            });
        }

        window.onload = () => {
            document.getElementById('tglBreak').value = new Date().toISOString().split('T')[0];
        };
    </script>
</body>
</html>
